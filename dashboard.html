<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - MyApp</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="dashboard-container">
        <nav class="navbar">
            <div class="nav-brand">
                <h2>MyApp</h2>
            </div>
            <div class="nav-user">
                <span id="welcomeMessage"></span>
                <button onclick="logout()" class="btn btn-secondary">Sign Out</button>
            </div>
        </nav>

        <div class="dashboard-content">
            <div class="dashboard-header">
                <h1 id="dashboardTitle">Login History</h1>
                <button onclick="refreshData()" class="btn btn-primary">Refresh</button>
            </div>

            <div class="stats-container" id="statsContainer">
                <!-- Stats cards -->
            </div>

            <div class="table-container">
                <table id="logTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>USERNAME</th>
                            <th>LOGIN TIME</th>
                            <th>IP ADDRESS</th>
                            <th>USER AGENT</th>
                        </tr>
                    </thead>
                    <tbody id="logTableBody">
                        <tr>
                            <td colspan="5" class="loading">Loading data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="app.js"></script>
    <script>
        const token = localStorage.getItem('token');
        const username = localStorage.getItem('username');
        const isAdmin = localStorage.getItem('isAdmin') === 'true';

        if (!token) {
            window.location.href = 'index.html';
        }

        document.getElementById('welcomeMessage').textContent = 
            isAdmin ? `${username} (Admin)` : username;

        if (isAdmin) {
            document.getElementById('dashboardTitle').textContent = 'All Users Login History';
        } else {
            document.getElementById('dashboardTitle').textContent = 'My Login History';
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'index.html';
        }

        async function loadDashboard() {
            try {
                const endpoint = isAdmin ? '/api/logs/all' : '/api/logs/me';
                const response = await fetch(`${API_URL}${endpoint}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 401) {
                    alert('Session expired. Please login again.');
                    logout();
                    return;
                }

                const data = await response.json();

                if (response.ok) {
                    displayStats(data.stats);
                    displayLogs(data.logs);
                } else {
                    alert('Failed to load data: ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Connection error. Please try again.');
            }
        }

        function displayStats(stats) {
            const statsContainer = document.getElementById('statsContainer');
            
            if (isAdmin) {
                statsContainer.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${stats.totalUsers || 0}</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.totalLogins || 0}</div>
                        <div class="stat-label">Total Logins</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.todayLogins || 0}</div>
                        <div class="stat-label">Today's Logins</div>
                    </div>
                `;
            } else {
                statsContainer.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${stats.totalLogins || 0}</div>
                        <div class="stat-label">Total Logins</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.lastLogin || 'Just now'}</div>
                        <div class="stat-label">Last Login</div>
                    </div>
                `;
            }
        }

        function displayLogs(logs) {
            const tbody = document.getElementById('logTableBody');
            
            if (!logs || logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="no-data">No login records found</td></tr>';
                return;
            }

            tbody.innerHTML = logs.map(log => `
                <tr>
                    <td>${log.id}</td>
                    <td>${log.username}</td>
                    <td>${new Date(log.login_time).toLocaleString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    })}</td>
                    <td>${log.ip_address || 'N/A'}</td>
                    <td class="user-agent">${log.user_agent || 'N/A'}</td>
                </tr>
            `).join('');
        }

        function refreshData() {
            document.getElementById('logTableBody').innerHTML = 
                '<tr><td colspan="5" class="loading">Loading data...</td></tr>';
            loadDashboard();
        }

        loadDashboard();
    </script>
</body>
</html>